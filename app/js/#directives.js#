'use strict';

/* Directives */


angular.module('myApp.directives', []).
  directive('appVersion', ['version', function(version) {
    return function(scope, elm, attrs) {
      elm.text(version);
    };
  }]);

App.directive("search", function($http){
  function link(scope, elm, attrs) {
    console.log("linke called");
  };

  function compile(element, attrs, transclude) {
    console.log(element);
    console.log(attrs);
    var el = $(element);
    var noResults = el.find("no-results");
    var item = el.find("result-item");
    var items = el.attr("items");
    var floating = el.attr("float");
    var model = el.attr("ngModel");
    el.children().remove();
    el.removeAttr("items");


    return link;
  };
  console.log("calling");
  return {
   restrict:"EA",
    compile : compile
  };

});

App.directive("dropFiles", function() {
  function stopEvent(e) {
    e.stopPropagation();
    e.preventDefault();
  }

  function canUploadType(scope, file) {
    var ext = file.name.match(".([a-z0-9]{1,10})$");
    return ext !== null && ext.length === 2 && scope.allowedTypes.indexOf(ext[1]) !== -1;
  }

  function addFile(scope, fileEntry) {
    console.log(fileEntry);
    fileEntry.file(function(f) {
      if (canUploadType(scope, f)) {
        scope.fileHandler(f);
        scope.$apply();
      }
    });
  }

  function readDirectory(scope, dirEntry) {
    dirEntry.createReader()
      .readEntries(function(entries) {
        handleEntries(scope, entries);
      });
  }

  function handleEntries(scope, entries) {
    var entry;
    for(var i = 0; i < entries.length; i++) {
      entry = entries[i];
      if (entry.isFile) {
        addFile(scope, entry);
      } else if (entry.isDirectory) {
        readDirectory(scope, entry);
      }
    }
  }

  function handleFiles(e) {
    var items = e.dataTransfer.items,
        entries = [];
        console.log(items[0]);
    for (var i = 0; i < items.length; i++) {
      entries[i] = items[i].webkitGetAsEntry();
    }
    return entries;
  }

  function handleInputFiles(scope, el) {
    console.log("handling file input");
    var files = el[0].files;
    for (var i = 0; i < files.length; i++) {
      console.log(files[i]);
      if (canUploadType(scope, files[i])) {
        scope.fileHandler(files[i]);
      }
    }
    scope.$apply();
  }

  function setupFileInput(scope, el) {
    var reEl = angular.element("<input type='file' multiple='true'/>");
    el.el.replaceWith(reEl);
    el.el = reEl;
    reEl.bind("change", function() {
      console.log("CHANGED");
      handleInputFiles(scope, reEl);
      setupFileInput(scope, el);
    });
  }

  return {
    restrict : "A",
    scope : {
      fileHandler : "=",
      enabled : "&",
    },
    transclude : true,
    template : "<span ng-transclude></span>, <span></span><button>or select files...</button>",
    link : function(scope, el, attrs) {
      scope.allowedTypes = attrs.filetypes.split(" ");
      var fileInput = {el : el.children().eq(1)};
      setupFileInput(scope, fileInput);
      el.children().eq(2).bind("click", function(e) {
        fileInput.el[0].click();
      });

      console.log(scope);
      el.bind("dragenter", function(e) {
        el.addClass("hover");
        stopEvent(e);
      })
      .bind("dragleave", function(e) {
        console.log("exiting");
        el.removeClass("hover");
        stopEvent(e);
      })
      .bind("dragover", stopEvent)
      .bind("drop", function(e) {
        stopEvent(e);
        el.removeClass("hover");
        if (scope.enabled()) {
          handleEntries(scope, handleFiles(e.originalEvent));
        }
      });
    }
  };
});

function updateProgress(el, e) {
  if (e.lengthComputable) {
    var percentComplete = 100 * (e.loaded / e.total);
    console.log("updating length " + percentComplete);
    console.log(el);

    el.css("right",  (100 - percentComplete) + "%");
  }
}

App.directive("uploadProgress", function() {
  return {
    restrict : "A",
    scope : {
      class : "@",
      progressClass : "@",
      xhr : "=",
      canStart : "=",
      startUploads : "="
    },
    replace : true,
    transclude : true,
    template : "<div ng-class='class'><div ng-transclude></div><div ng-class='progressClass'></div></div>",
    link : function(scope, el, attrs) {
  var progressDiv = el.children().eq(1);
      scope.xhr.upload.addEventListener("progress", function(evt) {
        console.log("PROGRESS");
        console.log(evt);
        updateProgress(progressDiv, evt);
      }, false);
      
      scope.xhr.addEventListener("load", function() {
        el.css("right", "0px");
      });

      if(scope.canStart) {
        scope.startUploads();
      }
    }
  }
});


